- name: Verificar si Docker est치 activo
  ansible.builtin.command: docker info
  register: docker_check
  ignore_errors: true

- name: Mostrar advertencia si Docker no est치 disponible
  ansible.builtin.debug:
    msg: "游뚿 Docker no est치 disponible o no se est치 ejecutando en este sistema."
  when: docker_check.failed

# Login temporal sin guardar credenciales ni activar Keychain
- name: Crear configuraci칩n temporal y login seguro
  ansible.builtin.shell: |
    mkdir -p /tmp/docker-login-config
    echo '{ "auths": { "{{ azure_acr_name }}.azurecr.io": {} } }' > /tmp/docker-login-config/config.json
    echo "{{ azure_acr_password }}" | DOCKER_CONFIG=/tmp/docker-login-config \
      docker login {{ azure_acr_name }}.azurecr.io \
      --username {{ azure_acr_username }} \
      --password-stdin
  args:
    executable: /bin/bash
  register: acr_login
  failed_when: acr_login.rc != 0
  when: not docker_check.failed

# Descargar im치genes p칰blicas
- name: Descargar im치genes
  ansible.builtin.command: >
    docker pull {{ item.source }}/{{ item.name }}:{{ item.tag }}
  loop: "{{ container_images }}"
  when: acr_login.rc == 0

# Etiquetar im치genes para el ACR
- name: Etiquetar im치genes
  ansible.builtin.command: >
    docker tag {{ item.source }}/{{ item.name }}:{{ item.tag }}
    {{ azure_acr_name }}.azurecr.io/{{ item.name }}:{{ item.tag }}
  loop: "{{ container_images }}"
  when: acr_login.rc == 0

# Subir im치genes al ACR
- name: Subir im치genes al ACR
  ansible.builtin.shell: |
    DOCKER_CONFIG=/tmp/docker-login-config \
    docker push {{ azure_acr_name }}.azurecr.io/{{ item.name }}:{{ item.tag }}
  loop: "{{ container_images }}"
  args:
    executable: /bin/bash
  when: acr_login.rc == 0


# Limpieza de configuraci칩n temporal
- name: Eliminar configuraci칩n temporal
  ansible.builtin.file:
    path: /tmp/docker-login-config
    state: absent
  when: not docker_check.failed
